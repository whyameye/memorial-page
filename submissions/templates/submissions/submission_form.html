{% extends "site_base.html" %}

{% load static %}
{% load bootstrap %}

{% block extra_head %}
  <link rel="stylesheet" href="{% static 'css/dropzone.css' %}" />
  <style>
    .form-group { margin-bottom: 1.5rem; }
    .dropzone .dz-remove {
      color: #c00;
      font-weight: bold;
    }
    /* Keep add-more box visible after uploads */
    .dropzone.dz-started .dz-message.add-more-box {
      display: inline-block !important;
    }
    /* Use flexbox to push add-more box to the right */
    .dropzone {
      display: flex;
      flex-wrap: wrap;
      align-items: flex-start;
    }
    .dropzone .add-more-box {
      order: 9999;
    }
    /* Add more photos box */
    .dropzone .add-more-box {
      display: inline-block;
      vertical-align: top;
      margin: 16px;
      width: 120px;
      height: 120px;
      border: 2px dashed #999;
      border-radius: 20px;
      cursor: pointer;
      text-align: center;
      color: #999;
    }
    .dropzone .add-more-box:hover {
      border-color: #666;
      color: #666;
    }
    .dropzone .add-more-box i {
      font-size: 36px;
      margin-top: 30px;
    }
    .dropzone .add-more-box span {
      display: block;
      font-size: 12px;
      margin-top: 5px;
    }
  </style>
{% endblock %}


{% block body %}

{% include "_header.html" %}

<script src="{% static 'js/dropzone.js' %}"></script>
<script>
Dropzone.options.dropzoneFiles = {};
Dropzone.options.dropzoneFiles['maxFilesize'] = 50;
Dropzone.options.dropzoneFiles['acceptedFiles'] = 'image/*';
Dropzone.options.dropzoneFiles['dictDefaultMessage'] = 'Drag & Drop or Click to add Images';
Dropzone.options.dropzoneFiles['dictRemoveFile'] = 'X';
Dropzone.options.dropzoneFiles['addRemoveLinks'] = true;
Dropzone.options.dropzoneFiles['addedfile'] = function(file, div) {
  console.log(this,file);
  this.defaultOptions.addedfile.call(this, file, div);
  if(file.status==Dropzone.SUCCESS) {
    this.defaultOptions.success.call(this, file, div);
  }
};
Dropzone.options.dropzoneFiles['removedfile'] = function(file) {
  fetch(file.removeLink, {
    method: 'POST',
    headers: {
      'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
    }
  });
  file.previewElement.parentNode.removeChild(file.previewElement);
  return true;
};
Dropzone.options.dropzoneFiles['success'] = function(file, response) {
  file.removeLink = response.removeLink;
};
Dropzone.options.dropzoneFiles['init'] = function() {
  var file = null;
  {% for file in form.instance.current_files %}
    file = {
      filename: "{{ file.file.name|escapejs }}",
      name: "{{ file.file.name|escapejs }}",
      size: "{{ file.file.size}}",
      type: "image/jpeg",
      removeLink: "{% url 'jfu-delete' pk=file.pk %}",
      status: Dropzone.SUCCESS,
      upload: {progress: 100, bytesSent: {{file.file.size}}, total: {{file.file.size}}},
      accepted: true
    };
    this.options.addedfile.call(this, file);
    this.options.thumbnail.call(this,file, '{{file.file.url}}');
    this.options.complete.call(this,file, file.upload.progress, file.upload.bytesSent);
    this.files.push(file);
  {% endfor %}
}
</script>

<div class="card p-4">
  <h2 class="mb-3">Your Submission</h2>
  {% if messages %}
    {% for message in messages %}
    <div class="alert alert-{{ message.tags|default:'info' }}">{{ message }}</div>
    {% endfor %}
  {% endif %}
  {% if form.errors %}
    <div class="alert alert-danger">
      <strong>Please fix the following:</strong>
      <ul class="mb-0 mt-2">
      {% for field, errors in form.errors.items %}
        {% for error in errors %}
        <li>{{ error }}</li>
        {% endfor %}
      {% endfor %}
      </ul>
    </div>
  {% endif %}
  {% if form.instance.submitted_at %}
    <div class="alert alert-success">
      <i class="bi bi-check-circle me-2"></i>Your submission has been received. Thank you!
    </div>
  {% else %}
    <p class="text-muted">Upload photos, add your story, then click <b>Submit</b> when ready.</p>
  {% endif %}
  <hr />
  <div class="row justify-content-center">
    <div class="col-sm-8 col-md-6">
      <label class="form-label">Photos <small class="text-muted fw-normal">File size: up to 50MB</small></label>
      <form action="{% url 'jfu-upload' pk=form.instance.pk %}" method="POST" class="dropzone" id="dropzone-files">
        {% csrf_token %}
        <div class="fallback">
          <input name="file" type="file" multiple class="form-control" />
        </div>
        <div class="add-more-box dz-message">
          <i class="bi bi-plus-lg"></i>
          <span>Add photos</span>
        </div>
      </form>
    </div>
  </div>
  <form method="POST" class="mt-4">
    <div class="row">
      <div class="col-md-6">
        {{form|bootstrap}}
        {% csrf_token %}
      </div>
      <div class="col-12 col-md-5 offset-md-1 mt-3 mt-md-0">
        <label class="form-label">Links</label>
        <p class="small text-muted mb-3">Share link to videos, social media posts, photo albums, articles, etc.</p>
        {% for links_formset in inlines %}
          {{links_formset.management_form}}
          {% for inline in links_formset %}
            <div class="mb-2">
              {{inline|bootstrap}}
            </div>
          {% endfor %}
        {% endfor %}
        <p class="small text-muted mt-2">YouTube and Vimeo links will be embedded automatically.</p>
      </div>
    </div>
    <div class="row mt-4">
      <div class="text-center">
        {% if not form.instance.submitted_at %}
        <a href="{% url 'home' %}" class="btn btn-link text-muted me-2">Cancel</a>
        <input type="submit" class="btn btn-outline-secondary me-2" name="save" value="Save Draft"/>
        <input type="submit" class="btn btn-success" name="send" value="Submit"/>
        {% else %}
        <a href="{% url 'home' %}" class="btn btn-primary">Back to Home</a>
        {% endif %}
      </div>
    </div>
  </form>
  {% if not form.instance.submitted_at %}
  <hr class="mt-4"/>
  <div class="text-center">
    <a href="{% url 'submission-delete' pk=form.instance.pk %}" class="btn btn-outline-danger btn-sm"
       onclick="return confirm('Are you sure you want to delete this draft?');">
      <i class="bi bi-trash me-1"></i>Delete Draft
    </a>
  </div>
  {% endif %}
</div>
{% endblock %}
